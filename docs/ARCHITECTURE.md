# Technical Architecture

## Tech Stack

| Layer | Technology | Reason |
|-------|-----------|--------|
| Frontend | SvelteKit 5 + Tailwind v4 + shadcn-svelte | Modern, fast, great DX, Svelte 5 runes |
| UI Components | shadcn-svelte (bits-ui) | Accessible, customizable, Tailwind-based |
| Backend + DB | Convex | Realtime database, serverless functions, zero infra |
| Telegram Bot | Convex HTTP Actions (webhook) | Bot logic lives in Convex, no separate server |
| LLM | Pluggable â€” Gemini (primary) | Fast, image support (receipt), cheap |
| Hosting | Cloudflare Pages | Edge deployment, fast globally, free tier |
| Package Manager | bun | Fast installs, lockfile already in repo |

---

## Project Structure

```
moneychat/
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ PRD.md                    # Product requirements
â”‚   â”œâ”€â”€ ARCHITECTURE.md           # This file
â”‚   â””â”€â”€ DATABASE.md               # Convex schema reference
â”œâ”€â”€ convex/
â”‚   â”œâ”€â”€ schema.ts                 # Database schema (tables + indexes)
â”‚   â”œâ”€â”€ users.ts                  # User queries & mutations
â”‚   â”œâ”€â”€ groups.ts                 # Group queries & mutations
â”‚   â”œâ”€â”€ transactions.ts           # Transaction queries & mutations
â”‚   â”œâ”€â”€ budgets.ts                # Budget queries & mutations
â”‚   â”œâ”€â”€ auth.ts                   # Telegram auth verification
â”‚   â”œâ”€â”€ telegram.ts               # Telegram bot action (message handling)
â”‚   â”œâ”€â”€ http.ts                   # HTTP routes (webhook endpoint)
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â””â”€â”€ llm/
â”‚   â”‚       â”œâ”€â”€ types.ts          # Shared LLM types
â”‚   â”‚       â”œâ”€â”€ gemini.ts         # Google Gemini provider
â”‚   â”‚       â””â”€â”€ index.ts          # Provider factory
â”‚   â””â”€â”€ _generated/               # Auto-generated by Convex
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app.html
â”‚   â”œâ”€â”€ app.d.ts
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ convex.ts             # Convex client setup
â”‚   â”‚   â”œâ”€â”€ auth.ts               # Client-side auth helpers
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ ui/               # shadcn-svelte components
â”‚   â”‚   â”‚   â”œâ”€â”€ SpendingChart.svelte
â”‚   â”‚   â”‚   â”œâ”€â”€ CategoryBreakdown.svelte
â”‚   â”‚   â”‚   â”œâ”€â”€ GroupSelector.svelte
â”‚   â”‚   â”‚   â”œâ”€â”€ TransactionList.svelte
â”‚   â”‚   â”‚   â””â”€â”€ BudgetProgress.svelte
â”‚   â”‚   â””â”€â”€ utils.ts
â”‚   â””â”€â”€ routes/
â”‚       â”œâ”€â”€ +layout.svelte        # Convex provider + auth
â”‚       â”œâ”€â”€ +page.svelte          # Landing / login
â”‚       â”œâ”€â”€ dashboard/
â”‚       â”‚   â”œâ”€â”€ +page.svelte      # Overview semua group
â”‚       â”‚   â””â”€â”€ group/[id]/
â”‚       â”‚       â””â”€â”€ +page.svelte  # Detail group + charts
â”‚       â””â”€â”€ chat/
â”‚           â””â”€â”€ +page.svelte      # Web chat interface (optional)
â”œâ”€â”€ static/                        # Static assets
â”œâ”€â”€ svelte.config.js               # SvelteKit + Cloudflare adapter
â”œâ”€â”€ vite.config.ts                 # Vite + Tailwind
â”œâ”€â”€ package.json
â”œâ”€â”€ .env.example
â”œâ”€â”€ .env.local                     # Local env (gitignored)
â”œâ”€â”€ .gitignore
â””â”€â”€ CLAUDE.md                      # Dev guide for Claude
```

---

## Request Flow

### 1. Expense Logging (via Telegram)

```
User sends "makan siang 35rb"
        â”‚
        â–¼
Telegram sends POST to Convex HTTP Action
  URL: https://<deployment>.convex.site/telegram-webhook
        â”‚
        â–¼
HTTP Action (convex/http.ts) receives update
        â”‚
        â–¼
Calls parseExpense action (convex/telegram.ts):
  â†’ Upserts user from Telegram data
  â†’ Sends message to LLM (Gemini):
      "makan siang 35rb"
  â†’ LLM returns:
      { amount: 35000, category: "food",
        description: "Makan siang",
        groupHint: null, date: "2026-02-27",
        confidence: 0.95 }
        â”‚
        â–¼
Resolves group (default or from groupHint)
        â”‚
        â–¼
Saves transaction via mutation (convex/transactions.ts)
        â”‚
        â–¼
Sends Telegram reply:
  "âœ… Makan siang - Rp35.000 (Food ğŸ”)
   ğŸ’° Sisa budget: Rp165.000"
```

### 2. Rekap Request (via Telegram)

```
User sends "rekap"
        â”‚
        â–¼
HTTP Action receives update
        â”‚
        â–¼
Detects "rekap" intent
        â”‚
        â–¼
Queries transactions summary (convex/transactions.ts)
  â†’ Aggregates by category for today
        â”‚
        â–¼
Formats rekap text + dashboard link
        â”‚
        â–¼
Sends Telegram reply with inline button:
  "ğŸ“Š Lihat Detail" â†’ web dashboard URL
```

### 3. Web Dashboard (via SvelteKit)

```
User opens dashboard in browser
        â”‚
        â–¼
Login via Telegram Login Widget
        â”‚
        â–¼
Telegram auth data â†’ Convex HTTP Action (verify signature)
        â”‚
        â–¼
Returns session token â†’ stored in client
        â”‚
        â–¼
SvelteKit app uses convex-svelte:
  useQuery(api.transactions.list, { groupId, dateRange })
        â”‚
        â–¼
Convex streams realtime data to frontend
        â”‚
        â–¼
Charts & tables auto-update when new transactions come in
```

---

## LLM Prompt Design

```
System Prompt:
You are a financial transaction parser for Indonesian users.
Extract expense information from casual Indonesian chat messages.

Always return valid JSON with these fields:
- amount: number (in IDR, parse "rb"=000, "k"=000, "jt"=000000)
- category: one of [food, transport, shopping, bills, health, entertainment, education, transfer, other]
- description: string (cleaned up description)
- groupHint: string | null (detected group context, e.g. "ortu" from "obat mama")
- date: string (ISO date, default today. Parse "kemarin"=yesterday, "tadi"=today)
- confidence: number (0-1, how confident you are in the parsing)

Examples:
Input: "makan siang 35rb"
Output: {"amount":35000,"category":"food","description":"Makan siang","groupHint":null,"date":"2026-02-27","confidence":0.95}

Input: "/ortu obat mama 200rb"
Output: {"amount":200000,"category":"health","description":"Obat mama","groupHint":"ortu","date":"2026-02-27","confidence":0.95}

Input: "kemarin grab ke kantor 25k"
Output: {"amount":25000,"category":"transport","description":"Grab ke kantor","groupHint":null,"date":"2026-02-26","confidence":0.90}
```

---

## Authentication Strategy

### Telegram â†’ Convex (Bot)
- Bot identifies user by `telegram_id` from webhook payload
- Convex upserts user record automatically on first message
- No auth needed â€” Telegram guarantees identity via webhook secret

### Telegram â†’ Web Dashboard
- Telegram Login Widget on login page
- Widget returns signed auth data (hash verified with bot token)
- Frontend sends auth data to Convex HTTP Action (`/auth/telegram`)
- Convex verifies HMAC-SHA256 signature â†’ creates session
- Session token stored in client, passed to Convex queries
- Dashboard uses token for authenticated queries

---

## Convex Functions Reference

### Queries (read-only, realtime)
- `users.getByTelegramId` â€” Get user by Telegram ID
- `users.getById` â€” Get user by Convex ID
- `transactions.list` â€” List transactions (filter by group, date, category)
- `transactions.summary` â€” Aggregated summary for period
- `transactions.monthlyTrends` â€” Monthly trend data
- `groups.listByUser` â€” List user's groups
- `groups.getMembers` â€” List members of a group
- `budgets.get` â€” Get budget for group + month

### Mutations (write, transactional)
- `users.upsert` â€” Create/update user from Telegram data
- `users.setDefaultGroup` â€” Set default logging group
- `transactions.create` â€” Save new transaction
- `transactions.remove` â€” Delete transaction
- `groups.create` â€” Create family group
- `groups.invite` â€” Invite member to group
- `budgets.set` â€” Set monthly budget

### Actions (side effects, external API calls)
- `telegram.parseExpense` â€” Parse message via LLM, save transaction
- `telegram.handleRekap` â€” Generate summary text

### HTTP Actions (public endpoints)
- `POST /telegram-webhook` â€” Telegram bot webhook
- `POST /auth/telegram` â€” Verify Telegram Login Widget auth

---

## LLM Provider Architecture

LLM provider is pluggable via environment variable `LLM_PROVIDER`.

```
convex/lib/llm/
â”œâ”€â”€ types.ts    â€” ParsedExpense interface, LLMProvider interface
â”œâ”€â”€ gemini.ts   â€” Google Gemini implementation (primary)
â””â”€â”€ index.ts    â€” Factory: getLLMProvider() returns provider based on env
```

Supported providers:
- `gemini` (default) â€” Fast, cheap, supports image/receipt parsing
- `claude` (future) â€” Great at structured extraction
- `openai` (future) â€” Alternative option

Environment variable: `LLM_PROVIDER=gemini`
